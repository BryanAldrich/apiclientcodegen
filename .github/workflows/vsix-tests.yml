name: VSIX Tests

on:
  workflow_dispatch:
  push:
    paths: 
    - '.github/workflows/vsix-tests.yml'
    branches: 
    - '*'

jobs:

  VSIX2019:
    runs-on: windows-2019
    continue-on-error: true
    steps:
    - name: Download VSIX for VS 2019
      run: |
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com'
        Start-Sleep -Seconds 1.5
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/search?term=REST%202022&target=VS'
        Start-Sleep -Seconds 1.5
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/items?itemName=ChristianResmaHelle.ApiClientCodeGenerator'
        Start-Sleep -Seconds 1.5
        $marketplace = 'https://christianresmahelle.gallery.vsassets.io/items?itemName=ChristianResmaHelle.ApiClientCodeGenerator'
        $path = ((Invoke-WebRequest -Uri $marketplace).Links | Where class -eq 'install-button-container').Href
        $downloadUri = "https://marketplace.visualstudio.com$path"
        Invoke-WebRequest $downloadUri -OutFile "vs2019.vsix"
    - name: Install VSIX
      run: Start-Process -FilePath 'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\VSIXInstaller.exe' -ArgumentList '/q vs2019.vsix' -Wait

  VSIX2022:
    runs-on: windows-2022
    continue-on-error: true
    steps:
    - name: Download VSIX for VS 2022
      run: |
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com'
        Start-Sleep -Seconds 1.5
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/search?term=REST%202022&target=VS'
        Start-Sleep -Seconds 1.5
        Invoke-WebRequest -Uri 'https://marketplace.visualstudio.com/items?itemName=ChristianResmaHelle.ApiClientCodeGenerator'
        Start-Sleep -Seconds 1.5
        $marketplace = 'https://christianresmahelle.gallery.vsassets.io/items?itemName=ChristianResmaHelle.ApiClientCodeGenerator2022'
        $path = ((Invoke-WebRequest -Uri $marketplace).Links | Where class -eq 'install-button-container').Href
        $downloadUri = "https://marketplace.visualstudio.com$path"
        Invoke-WebRequest $downloadUri -OutFile "vs2022.vsix"
    - name: Install VSIX
      run: Start-Process -FilePath 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\VSIXInstaller.exe' -ArgumentList '/q vs2022.vsix' -Wait
